<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dominator.mapper.ext.TPropertyExt">
    <resultMap id="BaseResultMap" type="Dto" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Mar 29 14:47:43 CST 2018.
        -->
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="property_name" property="propertyName" jdbcType="VARCHAR" />
        <result column="logo_url" property="logoUrl" jdbcType="VARCHAR" />
        <result column="logo_color" property="logoColor" jdbcType="VARCHAR" />
        <result column="telephone" property="telephone" jdbcType="VARCHAR" />
        <result column="phone_num" property="phoneNum" jdbcType="VARCHAR" />
        <result column="email" property="email" jdbcType="VARCHAR" />
        <result column="bank_name" property="bankName" jdbcType="VARCHAR" />
        <result column="bank_num" property="bankNum" jdbcType="VARCHAR" />
        <result column="bank_account_name" property="bankAccountName" jdbcType="VARCHAR" />
        <result column="province" property="province" jdbcType="VARCHAR" />
        <result column="city" property="city" jdbcType="VARCHAR" />
        <result column="area" property="area" jdbcType="VARCHAR" />
        <result column="street" property="street" jdbcType="VARCHAR" />
        <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="modify_id" property="modifyId" jdbcType="VARCHAR" />
        <result column="is_valid" property="isValid" jdbcType="VARCHAR" />
        <result column="mer_cust_id" property="merCustId" jdbcType="VARCHAR" />
        <result column="acct_id" property="acctId" jdbcType="VARCHAR" />
        <result column="nick_name" property="nickName" jdbcType="VARCHAR" />
        <result column="role_id" property="roleId" jdbcType="VARCHAR" />
        <result column="modules_ids" property="modulesIds" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getGardenToManager" parameterType="String" resultType="TGarden">
        SELECT g.id, g.garden_name
        FROM pms.t_garden g, pms.t_garden_user gu
        WHERE g.is_valid = '1'
        AND gu.is_valid = '1'
        AND g.id = gu.garden_id
        AND gu.user_id = #{user_id}
        ORDER BY gu.create_time
    </select>
    <select id="listGardens" parameterType="String" resultType="TGarden">
        SELECT g.garden_name, g.id
        FROM pms.t_garden g, t_garden_user gu
        WHERE g.is_valid = '1'
        AND gu.is_valid = '1'
        AND g.id = gu.garden_id
        AND gu.user_id = #{user_id}
    </select>
    <select id="listManagers" parameterType="Dto" resultType="Dto">
        SELECT u.nick_name,
        u.phone_num,
        u.user_name,
        pur.role_id,
        u.id
        FROM t_user u, t_property_user_role pur, t_role r
        WHERE u.is_valid = '1'
        AND pur.is_valid = '1'
        AND r.is_valid = '1'
        AND u.id = pur.user_id
        AND r.id = pur.role_id
        AND pur.property_id = #{property_id}
        AND r.role_name = #{role_name}
        ORDER BY r.sort
    </select>

    <select id="listGardenWechats" resultType="Dto">
        SELECT g.id as garden_wechat_id, w.*
        FROM t_garden_weixin_public_config g, tbl_wxopen_authorizer_account_info w
        WHERE g.is_valid = '1'
        AND g.weixin_config_id = w.id
        AND g.garden_id = #{garden_id}
        ORDER BY g.create_time
    </select>

    <select id="getPropertyIdByAppId" parameterType="java.lang.String" resultType="java.lang.String">
        SELECT  g.property_id
        FROM t_property_weixin_public_config g, tbl_wxopen_authorizer_account_info w
        WHERE g.is_valid = '1'
        AND g.weixin_config_id = w.id
        AND w.app_id = #{appId}
    </select>

    <select id="getPropertyByAppId" parameterType="java.lang.String" resultType="TProperty">
        SELECT p.*
        FROM t_property_weixin_public_config g, t_property p ,tbl_wxopen_authorizer_account_info w
        WHERE g.is_valid = '1'
        AND p.is_valid = '1'
        AND w.app_id = #{appId}
        AND g.weixin_config_id = w.id
        AND g.property_id = p.id
    </select>

    <select id="getPropertyByGardenId" parameterType="java.lang.String" resultType="Dto">
        SELECT p.acct_id,p.mer_cust_id,g.bank_name,g.bank_num,g.collection_unit
        FROM  t_property p ,t_garden g
        WHERE g.is_valid = '1'
        AND p.is_valid = '1'
        AND g.id = #{garden_id}
        AND g.property_id = p.id
    </select>

    <select id="listProperties" parameterType="Dto" resultType="Dto" resultMap="BaseResultMap">
        SELECT p.*,
        pur.nick_name,
        pur.role_id,
        IF(LENGTH(pur.modules_ids)=0,'0','1') as moduleStatus
        FROM t_property p, t_property_user_role pur, t_role r
        WHERE pur.is_valid = '1'
        AND r.is_valid = '1'
        AND p.id = pur.property_id
        AND r.id = pur.role_id
        AND r.role_name = '物业管理员'
        <if test="isValid != null and !&quot;&quot;.equals(isValid)">
            AND p.is_valid = #{isValid}
        </if>
        <if test="condition != null and !&quot;&quot;.equals(condition)">
            AND (
            p.phone_num like concat('%', #{condition}, '%')
            OR pur.nick_name like concat('%', #{condition}, '%')
            OR p.property_name like concat('%', #{condition}, '%')
            )
        </if>

    </select>

    <select id="getProperty" parameterType="Dto" resultType="Dto" resultMap="BaseResultMap">
        SELECT p.*,
        pur.nick_name,
        pur.role_id,
        pur.modules_ids
        FROM t_property p, t_property_user_role pur, t_role r
        WHERE pur.is_valid = '1'
        AND r.is_valid = '1'
        AND p.id = pur.property_id
        AND r.id = pur.role_id
        AND r.id = #{roleId}
        AND p.id = #{propertyId}
    </select>

    <select id="getPropertyUser" parameterType="Dto" resultType="Dto">
        SELECT r.role_name,r.id as role_id ,p.property_name as name ,"3" as type   ,g.id as garden_id,p.id FROM t_property p ,t_property_user_role pur,t_property_weixin_public_config pw
        ,t_role r,t_garden g,t_property_user pu
        WHERE pur.is_valid = '1'
        AND pw.is_valid = '1'
        AND r.is_valid = '1'
        AND g.is_valid = '1'
        AND pu.is_valid = '1'
        AND pu.status = '1'
        AND pw.property_id = #{property_id}
        AND pw.property_id = p.id
        AND pu.user_id  = #{user_id}
        AND pu.property_id = g.property_id
        AND pur.role_id = r.id
        AND p.id = pur.property_id
        AND pur.property_id = p.id
        AND pu.user_id = pur.user_id
        AND g.property_id = p.id
        limit 1
    </select>

</mapper>
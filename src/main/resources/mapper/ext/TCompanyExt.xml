<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dominator.mapper.ext.TCompanyExt">
    <resultMap id="BaseResultMap" type="Dto" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Mar 29 14:47:43 CST 2018.
        -->
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="garden_id" property="gardenId" jdbcType="VARCHAR" />
        <result column="company_name" property="companyName" jdbcType="VARCHAR" />
        <result column="contact_name" property="contactName" jdbcType="VARCHAR" />
        <result column="contact_phone" property="contactPhone" jdbcType="VARCHAR" />
        <result column="register_phone" property="registerPhone" jdbcType="VARCHAR" />
        <result column="bank_name" property="bankName" jdbcType="VARCHAR" />
        <result column="bank_num" property="bankNum" jdbcType="VARCHAR" />
        <result column="credit_num" property="creditNum" jdbcType="VARCHAR" />
        <result column="legal_person" property="legalPerson" jdbcType="VARCHAR" />
        <result column="licence_url" property="licenceUrl" jdbcType="VARCHAR" />
        <result column="logo_url" property="logoUrl" jdbcType="VARCHAR" />
        <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="status" property="status" jdbcType="VARCHAR" />
        <result column="modify_id" property="modifyId" jdbcType="VARCHAR" />
        <result column="is_valid" property="isValid" jdbcType="VARCHAR" />
        <result column="nick_name" property="nickName" jdbcType="VARCHAR" />
        <result column="role_id" property="roleId" jdbcType="VARCHAR" />
        <result column="modules_ids" property="modulesIds" jdbcType="VARCHAR" />
    </resultMap>
    <select id="getCompany" parameterType="String" resultType="Dto" resultMap="BaseResultMap">
        SELECT c.*,
        cur.nick_name,
        cur.role_id,
        cur.modules_ids
        FROM t_company c, t_company_user_role cur, t_role r
        WHERE cur.is_valid = '1'
        AND r.is_valid = '1'
        AND c.is_valid = '1'
        AND c.id = cur.company_id
        AND r.id = cur.role_id
        AND r.id = #{roleId}
        AND c.id = #{companyId}
    </select>

    <select id="listBills" resultType="Dto">
        SELECT cb.*,
        concat(LEFT(cb.bill_year_month,4), "年", RIGHT(cb.bill_year_month,2), "月",
        case
        when cb.fee_type='0' then "水费"
        when cb.fee_type='1' then "电费"
        when cb.fee_type='2' then "燃气费"
        when cb.fee_type='3' then "房租"
        when cb.fee_type='4' then "物业费"
        end
        ) as bill_name,
        cb.id as company_bill_id,
        c.id as company_id,
        c.company_name
        FROM t_company_bill cb, t_company c
        WHERE cb.is_valid = '1'
        AND c.is_valid = '1'
        AND cb.company_id = c.id
        <if test="company_id != null and !&quot;&quot;.equals(company_id)">
            AND cb.company_id = #{company_id}
        </if>
        <if test="garden_id != null and !&quot;&quot;.equals(garden_id)">
            AND c.garden_id = #{garden_id}
        </if>
        <if test="fee_type != null and !&quot;&quot;.equals(fee_type)">
            AND cb.fee_type = #{fee_type}
        </if>
        <if test="expiry_time_start != null and !&quot;&quot;.equals(expiry_time_start)">
            AND cb.expiry_time >= #{expiry_time_start}
        </if>
        <if test="expiry_time_end != null and !&quot;&quot;.equals(expiry_time_end)">
            AND cb.expiry_time <![CDATA[ <= ]]> #{expiry_time_end}
        </if>
        <if test="pay_time_start != null and !&quot;&quot;.equals(pay_time_start)">
            AND cb.pay_time >= #{pay_time_start}
        </if>
        <if test="pay_time_end != null and !&quot;&quot;.equals(pay_time_end)">
            AND cb.pay_time <![CDATA[ <= ]]> #{pay_time_end}
        </if>
        <if test="is_paid != null and !&quot;&quot;.equals(is_paid)">
            AND cb.is_paid = #{is_paid}
        </if>
        <if test="is_pushed != null and !&quot;&quot;.equals(is_pushed)">
            AND cb.is_pushed = #{is_pushed}
        </if>
        <if test="condition != null and !&quot;&quot;.equals(condition)">
            AND (
            c.company_name like concat('%', #{condition}, '%')
            OR cb.bill_num like concat('%', #{condition}, '%')
            )
        </if>
        ORDER BY cb.create_time DESC
    </select>
    <select id="listCompanyUnpaidInfoPage" parameterType="Dto" resultType="Dto">
        SELECT c.*, b.paid_fee, concat(a.province , a.city , a.area , a.street) as contact_address
        FROM t_company c
        LEFT JOIN v_company_bill b ON c.id = b.company_id AND b.is_paid = '0'
        LEFT JOIN t_address a ON a.owner_id = c.id AND a.type = '2' AND a.is_valid = '1'
        WHERE c.is_valid = '1'
        AND c.garden_id = #{garden_id}
        <if test="condition != null and !&quot;&quot;.equals(condition)">
            AND (
            c.company_name like concat('%', #{condition}, '%')
            OR c.contact_name like concat('%', #{condition}, '%')
            OR c.contact_phone like concat('%', #{condition}, '%')
            )
        </if>
    </select>

    <select id="listPage" resultType="Dto">
        SELECT
        c.company_name,
        c.contact_name,
        c.contact_phone,
        c.contact_address,
        cb.paid_fee,
        c.id as company_id
        FROM t_company c, v_company_bill cb
        WHERE c.id = cb.company_id
        AND c.is_valid = '1'
        AND c.garden_id = #{garden_id}
        <if test="condition != null">
            AND (
            c.company_name LIKE concat('%', #{condition}, '%')
            OR c.contact_name LIKE concat('%', #{condition}, '%')
            OR c.contact_phone LIKE concat('%', #{condition}, '%')
            )
        </if>
        <if test="is_paid != null and !&quot;&quot;.equals(is_paid)">
            AND cb.is_paid = #{is_paid}
        </if>
    </select>

    <select id="list" resultType="Dto">
        SELECT
        c.company_name,
        c.contact_name,
        c.contact_phone,
        c.contact_address,
        cb.paid_fee,
        c.id as company_id
        FROM t_company c, v_company_bill cb
        WHERE c.id = cb.company_id
        AND c.is_valid = '1'
        AND c.garden_id = #{garden_id}
        <if test="condition != null">
            AND (
            c.company_name LIKE concat('%', #{condition}, '%')
            OR c.contact_name LIKE concat('%', #{condition}, '%')
            OR c.contact_phone LIKE concat('%', #{condition}, '%')
            )
        </if>
        <if test="is_paid != null and !&quot;&quot;.equals(is_paid)">
            AND cb.is_paid = #{is_paid}
        </if>
    </select>

    <select id="getFee" resultType="java.math.BigDecimal">
        SELECT paid_fee
        FROM v_company_bill
        WHERE company_id = #{company_id}
        AND is_paid = #{is_paid}
        limit 1
    </select>

    <select id="getCompanyId"  resultType="Dto">
        select cu.company_id , c.company_name from t_company_user cu ,  t_user u ,t_company c
        WHERE
        u.is_valid = '1'
        AND cu.is_valid = '1'
        AND u.user_name = #{user_name}
        AND  cu.user_id = u.id
        AND  cu.company_id = c.id
    </select>

    <select id="listCompanyUsersPage" parameterType="Dto" resultType="Dto">
        SELECT
        u.*,
        cu.work_num,
        cu.department_name,
        cu.position,
        cu.hire_date,
        cu.status,
        u.id as user_id,
        cu.id as company_user_id,
        cur.role_id,
        r.role_name,
        if(r.role_name='企业管理员', '1', '0') as is_manager
        FROM t_user u, t_company_user cu
        LEFT JOIN pms.t_company_user_role cur
        ON cur.is_valid = '1'
        AND cur.company_id = cu.company_id
        AND cur.user_id = cu.user_id
        LEFT JOIN t_role r
        ON r.is_valid = '1'
        AND r.id = cur.role_id
        WHERE u.is_valid = '1'
        AND cu.is_valid = '1'
        AND cu.company_id = #{company_id}
        AND u.id = cu.user_id
        <if test="status != null and !&quot;&quot;.equals(status)">
            AND cu.status = #{status}
        </if>
        <if test="condition != null">
            AND (
            u.nick_name LIKE concat('%', #{condition}, '%')
            OR u.phone_num LIKE concat('%', #{condition}, '%')
            OR cu.work_num LIKE concat('%', #{condition}, '%')
            )
        </if>
        ORDER BY cu.create_time ASC
    </select>

    <select id="listCompanyRepairPage"  resultType="Dto">
        select @rowno:=@rowno+1 as rowno,
        u.nick_name,
        u.phone_num as company_user_phone,
        r.id as repair_id,
        r.repair_num,
        r.repair_content,
        r.repair_time,
        r.assign_time,
        r.complete_time,
        r.repair_status,
        r.repair_pics,
        u.id as user_id
        FROM t_user u, t_repair r ,(SELECT @rowno:=0) t
        WHERE u.id = r.repair_user_id
        AND r.company_id = #{company_id}
        AND u.is_valid = '1'
        AND r.is_valid = '1'
        AND r.repair_status = #{repair_status ,jdbcType=VARCHAR}
        <if test="create_time!=null and create_time!='' ">
            AND repair_time &gt;= #{create_time}
        </if>
        <if test="end_time!=null and end_time!='' ">
            AND repair_time &lt;= #{end_time}
        </if>
        <if test='repair_status!=null and repair_status=="0" '>
            ORDER BY r.repair_time DESC
        </if>
        <if test='repair_status!=null and repair_status=="1" '>
            ORDER BY r.assign_time DESC
        </if>
        <if test='repair_status!=null and repair_status=="2" '>
            ORDER BY r.complete_time DESC
        </if>
    </select>

    <select id="getCompanyByUserId" parameterType="Dto" resultType="TCompany">
        SELECT c.* FROM t_company_user cu ,t_company c WHERE
        cu.is_valid = '1'
        AND c.is_valid = '1'
        AND cu.user_id = #{user_id}
        AND cu.company_id = #{company_id}
        AND c.id = cu.company_id
    </select>

    <select id="countCompanyUser" parameterType="Dto" resultType="Integer">
        SELECT count(*) FROM t_company_user
        WHERE is_valid = '1'
        AND company_id = #{company_id}
        AND status = #{status}
        AND user_id NOT IN (
        SELECT user_id FROM t_company_user_role WHERE is_valid = '1' AND role_id = #{company_admin_id}
        )
    </select>

    <select id="getCompanyFee" parameterType="Dto" resultType="BigDecimal">
        SELECT total_fee FROM v_company_bill_push
        WHERE company_id = #{company_id}
        AND is_pushed = #{is_pushed}
    </select>
</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dominator.mapper.ext.TGardenExt">
    <resultMap id="BaseResultMap" type="Dto" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Thu Mar 29 14:47:43 CST 2018.
        -->
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="property_id" property="propertyId" jdbcType="VARCHAR" />
        <result column="zj_park_id" property="zjParkId" jdbcType="VARCHAR" />
        <result column="garden_name" property="gardenName" jdbcType="VARCHAR" />
        <result column="telephone" property="telephone" jdbcType="VARCHAR" />
        <result column="phone_num" property="phoneNum" jdbcType="VARCHAR" />
        <result column="bank_name" property="bankName" jdbcType="VARCHAR" />
        <result column="bank_num" property="bankNum" jdbcType="VARCHAR" />
        <result column="collection_unit" property="collectionUnit" jdbcType="VARCHAR" />
        <result column="province" property="province" jdbcType="VARCHAR" />
        <result column="city" property="city" jdbcType="VARCHAR" />
        <result column="area" property="area" jdbcType="VARCHAR" />
        <result column="street" property="street" jdbcType="VARCHAR" />
        <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="modify_id" property="modifyId" jdbcType="VARCHAR" />
        <result column="is_valid" property="isValid" jdbcType="VARCHAR" />
        <result column="nick_name" property="nickName" jdbcType="VARCHAR" />
        <result column="role_id" property="roleId" jdbcType="VARCHAR" />
        <result column="modules_ids" property="modulesIds" jdbcType="VARCHAR" />

        <result column="company_id" jdbcType="VARCHAR" property="companyId" />
        <result column="garden_id" jdbcType="VARCHAR" property="gardenId" />
        <result column="bill_num" jdbcType="VARCHAR" property="billNum" />
        <result column="bill_year_month" jdbcType="VARCHAR" property="billYearMonth" />
        <result column="total_fee" jdbcType="DECIMAL" property="totalFee" />
        <result column="main_fee" jdbcType="DECIMAL" property="mainFee" />
        <result column="other_fee" jdbcType="DECIMAL" property="otherFee" />
        <result column="fee_unit" jdbcType="DECIMAL" property="feeUnit" />
        <result column="fee_dgree" jdbcType="DECIMAL" property="feeDgree" />
        <result column="fee_type" jdbcType="VARCHAR" property="feeType" />
        <result column="is_pushed" jdbcType="VARCHAR" property="isPushed" />
        <result column="push_time" jdbcType="TIMESTAMP" property="pushTime" />
        <result column="expiry_time" jdbcType="TIMESTAMP" property="expiryTime" />
        <result column="is_paid" jdbcType="VARCHAR" property="isPaid" />
        <result column="pay_time" jdbcType="TIMESTAMP" property="payTime" />
        <result column="is_valid" jdbcType="VARCHAR" property="isValid" />
        <result column="company_name" jdbcType="VARCHAR" property="companyName" />
    </resultMap>
    <select id="getGarden" parameterType="Dto" resultType="Dto" resultMap="BaseResultMap">
        SELECT g.*,
        gur.nick_name,
        gur.role_id,
        gur.modules_ids
        FROM t_garden g, t_garden_user_role gur, t_role r
        WHERE gur.is_valid = '1'
        AND r.is_valid = '1'
        AND g.id = gur.garden_id
        AND r.id = gur.role_id
        AND r.id = #{roleId}
        AND g.id = #{gardenId}
    </select>

    <select id="listGarden" parameterType="Dto" resultType="Dto">
        SELECT *
        <if test="role_id != null and !&quot;&quot;.equals(role_id)">
            , #{role_id} as role_id
        </if>
        FROM t_garden
        WHERE property_id = #{property_id}
        <if test="is_valid != null ">
            AND is_valid = #{is_valid}
        </if>
        <if test="garden_name != null ">
            AND garden_name LIKE concat('%', #{garden_name}, '%')
        </if>
        ORDER BY is_valid DESC,create_time ASC
    </select>

    <select id="listWithoutManagerGarden" parameterType="Dto" resultType="TGarden">
        SELECT *
        FROM t_garden
        WHERE property_id = #{property_id}
        AND is_valid = '1'
        AND id NOT IN (
        SELECT g.id
        FROM t_garden g , pms.t_garden_user_role gur, t_role r
        WHERE g.is_valid = '1'
        AND gur.is_valid = '1'
        AND r.is_valid = '1'
        AND g.id = gur.garden_id
        AND r.id = gur.role_id
        AND r.role_name = '园区管理员'
        AND g.property_id = #{property_id}
        )
        ORDER BY garden_name
    </select>

    <select id="overviewByType" resultType="BigDecimal">
        SELECT IFNULL(SUM(total_fee), 0)
        FROM t_company_bill
        WHERE is_valid = '1'
        AND company_id IN (
        SELECT id FROM t_company
        WHERE garden_id = #{garden_id}
        )
        AND bill_year_month = #{bill_year_month}
        AND fee_type = #{fee_type}
        AND is_paid = #{is_paid}
    </select>

    <!--garden_id String 必传 园区id-->
    <!--company_id-->
    <!--fee_type String 必传 默认0  费用类型 0水 1电费 2煤气 3房租物业-->
    <!--is_paid String 必传 默认0 0待缴费 1已缴费-->
    <!--is_pushed String 必传 默认1 0待推送，1已推送-->
    <!--startTime datetime 非必传-->
    <!--endTime datetime 非必传-->
    <!--condition String 非必传 账单号/缴费单位-->
    <select id="listBills" parameterType="Dto" resultType="Dto">
        SELECT cb.*,c.company_name,
        concat(LEFT(cb.bill_year_month,4),"年-",RIGHT(cb.bill_year_month,2), "月",
        case
        when cb.fee_type='0' then "水费"
        when cb.fee_type='1' then "电费"
        when cb.fee_type='2' then "燃气费"
        when cb.fee_type='3' then "房租"
        when cb.fee_type='4' then "物业"
        end
        ) as bill_name,
        cb.id as company_bill_id,
        c.id as company_id
        FROM t_company_bill cb, t_company c
        WHERE cb.company_id = c.id
        AND cb.is_valid = '1'
        AND c.is_valid = '1'
        <if test="is_paid != null and !&quot;&quot;.equals(is_paid)">
            AND cb.is_paid = #{is_paid}
        </if>
        <if test="garden_id != null and !&quot;&quot;.equals(garden_id)">
            AND c.garden_id = #{garden_id}
        </if>
        <if test="company_id != null and !&quot;&quot;.equals(company_id)">
            AND c.id = #{company_id}
        </if>
        <if test="is_pushed != null and !&quot;&quot;.equals(is_pushed)">
            AND cb.is_pushed = #{is_pushed}
        </if>
        <if test="fee_type != null and !&quot;&quot;.equals(fee_type)">
            AND cb.fee_type = #{fee_type}
        </if>
        <if test="condition != null">
            AND (
            cb.bill_num like concat('%', #{condition}, '%')
            OR c.company_name like concat('%', #{condition}, '%')
            )
        </if>
        <if test="startTime != null and !&quot;&quot;.equals(startTime)">
            AND cb.expiry_time >= #{startTime}
        </if>
        <if test="endTime != null and !&quot;&quot;.equals(endTime)">
            AND cb.expiry_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="is_paid == 0">
            ORDER BY cb.create_time desc
        </if>
        <if test="is_paid == 1">
            ORDER BY cb.pay_time desc
        </if>
    </select>

    <select id="listBillsPage" parameterType="Dto" resultType="Dto" resultMap="BaseResultMap">
        SELECT cb.*,c.company_name,
        concat(LEFT(cb.bill_year_month,4),RIGHT(cb.bill_year_month,2), "月",
        case
        when cb.fee_type='0' then "水费"
        when cb.fee_type='1' then "电费"
        when cb.fee_type='2' then "燃气费"
        when cb.fee_type='3' then "房租"
        when cb.fee_type='4' then "物业"
        end
        ) as billName,
        cb.id as billId
        FROM t_company_bill cb, t_company c
        WHERE cb.company_id = c.id
        AND cb.is_valid = '1'
        AND c.is_valid = '1'
        <if test="isPaid != null and !&quot;&quot;.equals(isPaid)">
            AND cb.is_paid = #{isPaid}
        </if>
        <if test="gardenId != null and !&quot;&quot;.equals(gardenId)">
            AND cb.garden_id = #{gardenId}
        </if>
        <if test="companyId != null and !&quot;&quot;.equals(companyId)">
            AND c.id = #{companyId}
        </if>
        <if test="isPushed != null and !&quot;&quot;.equals(isPushed)">
            AND cb.is_pushed = #{isPushed}
        </if>
        <if test="feeType != null and !&quot;&quot;.equals(feeType)">
            AND cb.fee_type = #{feeType}
        </if>
        <if test="condition != null">
            AND (
            cb.bill_num like concat('%', #{condition}, '%')
            OR c.company_name like concat('%', #{condition}, '%')
            )
        </if>
        <if test="startTime != null and !&quot;&quot;.equals(startTime)">
            AND cb.expiry_time >= #{startTime}
        </if>
        <if test="endTime != null and !&quot;&quot;.equals(endTime)">
            AND cb.expiry_time <![CDATA[ <= ]]> #{endTime}
        </if>
        <if test="isPaid == 0">
            ORDER BY cb.create_time desc
        </if>
        <if test="isPaid == 1">
            ORDER BY cb.pay_time desc
        </if>
    </select>

    <select id="listGardenCompanies" resultType="Dto" resultMap="BaseResultMap">
        SELECT id as company_id, company_name
        FROM t_company
        WHERE is_valid = '1'
        AND garden_id = #{gardenId}
        <if test="company_name != null ">
            AND company_name LIKE concat('%', #{companyName}, '%')
        </if>
        ORDER BY company_name
    </select>

    <select id="listGardenRepairPage" resultType="Dto">
        select @rowno:=@rowno+1 as rowno,
        u.nick_name,
        u.phone_num as company_user_phone,
        r.id as repair_id,
        r.repair_num,
        r.repair_content,
        r.repair_time,
        r.assign_time,
        r.complete_time,
        r.repair_status,
        r.repair_pics,
        u.id as user_id
        FROM t_user u, t_repair r ,(SELECT @rowno:=0) t
        WHERE r.garden_id = #{garden_id}
        and u.id = r.repair_user_id
        AND u.is_valid = '1'
        AND r.is_valid = '1'
        AND r.repair_status = #{repair_status}
        <if test="create_time!=null and create_time!='' ">
            AND repair_time &gt;= #{create_time}
        </if>
        <if test="end_time!=null and end_time!='' ">
            AND repair_time &lt;= #{end_time}
        </if>
        <if test='repair_status!=null and repair_status=="0" '>
            ORDER BY r.repair_time DESC
        </if>
        <if test='repair_status!=null and repair_status=="1" '>
            ORDER BY r.assign_time DESC
        </if>
        <if test='repair_status!=null and repair_status=="2" '>
            ORDER BY r.complete_time DESC
        </if>
    </select>

    <select id="listGardenUser" parameterType="Dto" resultType="Dto">
        SELECT u.id,u.nick_name,u.phone_num as garden_user_phone FROM t_garden_user gu, t_user u WHERE u.is_valid = '1'
        AND gu.is_valid = '1'
        AND gu.garden_id = #{garden_id}
        AND gu.user_id = u.id
        AND gu.status = '1'
    </select>

    <select id="listCompanyUnpaidInfoPage" parameterType="Dto" resultType="Dto">
        SELECT c.*, b.paid_fee, concat(a.province , a.city , a.area , a.street) as contact_address
        FROM t_company c
        LEFT JOIN v_company_bill b ON c.id = b.company_id AND b.is_paid = '0'
        LEFT JOIN t_address a ON a.owner_id = c.id AND a.type = '2' AND a.is_valid = '1'
        WHERE c.is_valid = '1'
        AND c.garden_id = #{garden_id}
        <if test="condition != null and !&quot;&quot;.equals(condition)">
            AND (
            c.company_name like concat('%', #{condition}, '%')
            OR c.contact_name like concat('%', #{condition}, '%')
            OR c.contact_phone like concat('%', #{condition}, '%')
            )
        </if>
    </select>

    <update id="delCompanyBills" parameterType="Dto">
        UPDATE t_company_bill
        SET modify_time = now(), modify_id = #{modify_id}, is_valid = '0'
        WHERE company_id = #{company_id}
        AND is_valid = '1'
    </update>

    <delete id="delCompanyUser" parameterType="Dto">
        DELETE FROM t_company_user WHERE company_id = #{company_id}
    </delete>

    <delete id="delCompanyUserRole" parameterType="Dto">
        DELETE FROM t_company_user_role WHERE company_id = #{company_id}
    </delete>

    <select id="countGardenUser" parameterType="Dto" resultType="Integer">
        SELECT count(*) FROM t_garden_user
        WHERE is_valid = '1'
        AND garden_id = #{garden_id}
        AND status = #{status}
        AND user_id NOT IN (
        SELECT user_id FROM t_garden_user_role
        WHERE is_valid = '1' AND (role_id = #{super_admin_id} or role_id = #{admin_id})
        )
    </select>

    <select id="listGardenRole" parameterType="Dto" resultType="Dto">
        SELECT * FROM t_role WHERE
        is_valid = '1'
        AND id IN (
        SELECT DISTINCT role_id
        FROM t_garden_role_modules
        WHERE is_valid = '1'
        AND garden_id = #{garden_id}
        )
        ORDER BY sort
    </select>
    <select id="listRoleModules" parameterType="Dto" resultType="TModules">
        SELECT m.modules_name, m.id
        FROM t_modules m, t_garden_role_modules grm
        WHERE m.is_valid = '1'
        AND grm.is_valid = '1'
        AND m.id = grm.modules_id
        AND grm.garden_id = #{garden_id}
        AND grm.role_id = #{role_id}
    </select>

    <select id="parkList" parameterType="java.lang.String" resultType="Dto">
        SELECT g.zj_park_id,g.id FROM t_garden g ,t_property_weixin_public_config pw ,tbl_wxopen_authorizer_account_info wa WHERE
        g.is_valid = '1'
        AND pw.is_valid = '1'
        AND wa.app_id = #{appId}
        AND wa.id = pw.weixin_config_id
        AND pw.property_id = g.property_id
    </select>

    <select id="getGardenById" parameterType="java.lang.String" resultType="Dto">
        SELECT g.id,g.garden_name,a.* FROM t_garden g,t_address a WHERE
        g.is_valid = '1'
        AND a.is_valid = '1'
        AND g.id = #{garden_id}
        AND g.id = a.owner_id
    </select>

    <select id="listByUser" parameterType="Dto" resultType="Dto" resultMap="BaseResultMap">
        SELECT DISTINCT g.id, g.garden_name
        FROM pms.t_garden g, pms.t_garden_user_role gur
        WHERE g.is_valid = '1'
        AND gur.is_valid = '1'
        AND g.id = gur.garden_id
        AND gur.user_id = #{userId}
        AND g.property_id = #{propertyId}
        ORDER BY g.create_time
    </select>

    <select id="selectByGardenId" parameterType="java.lang.String" resultType="Dto">
        SELECT u.id as user_id ,u.user_name as phone_num,wa.app_id
        from t_garden_user_role gur,
        t_role r,
        t_property_weixin_public_config pw,
        tbl_wxopen_authorizer_account_info wa,
        t_user u,
        t_garden g
        WHERE
        gur.is_valid = '1'
        AND  u.is_valid = '1'
        AND  r.is_valid = '1'
        AND  g.is_valid = '1'
        AND  pw.is_valid = '1'
        AND  gur.garden_id= #{garden_id, jdbcType=VARCHAR}
        AND  gur.role_id = r.id
        AND  r.role_name = '园区管理员'
        AND  gur.user_id = u.id
        AND gur.garden_id = g.id
        AND g.property_id = pw.property_id
        AND wa.id = pw.weixin_config_id
        limit 1
    </select>
</mapper>
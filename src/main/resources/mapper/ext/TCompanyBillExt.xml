<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dominator.mapper.ext.TCompanyBillExt">
    <resultMap id="BaseResultMap" type="Dto">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Tue Apr 10 16:28:42 CST 2018.
        -->
        <id column="id" jdbcType="VARCHAR" property="id" />
        <result column="company_id" jdbcType="VARCHAR" property="companyId" />
        <result column="garden_id" jdbcType="VARCHAR" property="gardenId" />
        <result column="bill_num" jdbcType="VARCHAR" property="billNum" />
        <result column="bill_year_month" jdbcType="VARCHAR" property="billYearMonth" />
        <result column="total_fee" jdbcType="DECIMAL" property="totalFee" />
        <result column="main_fee" jdbcType="DECIMAL" property="mainFee" />
        <result column="other_fee" jdbcType="DECIMAL" property="otherFee" />
        <result column="fee_unit" jdbcType="DECIMAL" property="feeUnit" />
        <result column="fee_dgree" jdbcType="DECIMAL" property="feeDgree" />
        <result column="fee_type" jdbcType="VARCHAR" property="feeType" />
        <result column="is_pushed" jdbcType="VARCHAR" property="isPushed" />
        <result column="push_time" jdbcType="TIMESTAMP" property="pushTime" />
        <result column="expiry_time" jdbcType="TIMESTAMP" property="expiryTime" />
        <result column="is_paid" jdbcType="VARCHAR" property="isPaid" />
        <result column="pay_time" jdbcType="TIMESTAMP" property="payTime" />
        <result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="modify_id" jdbcType="VARCHAR" property="modifyId" />
        <result column="is_valid" jdbcType="VARCHAR" property="isValid" />
    </resultMap>
    <select id="payOverview" resultType="BigDecimal">
        SELECT IFNULL(SUM(total_fee), 0) as totalFee FROM t_company_bill
        WHERE
        company_id IN (
        SELECT id FROM t_company
        WHERE garden_id = #{gardenId}
        )
        <if test="isPaid == 0">
            and DATE (create_time) = DATE (#{start})
        </if>
        <if test="isPaid == 1">
            AND is_paid = '1'
            AND DATE (pay_time) = DATE (#{start})
        </if>
        and is_valid='1'
    </select>

    <select id="listBillsByPage" resultType="Dto">
        SELECT cb.*,
        concat(LEFT(cb.bill_year_month,4), "年", RIGHT(cb.bill_year_month,2), "月",
        case
        when cb.fee_type='0' then "水费"
        when cb.fee_type='1' then "电费"
        when cb.fee_type='2' then "燃气费"
        when cb.fee_type='3' then "房租"
        when cb.fee_type='4' then "物业费"
        end
        ) as bill_name,
        cb.id as company_bill_id,
        c.id as company_id,
        c.company_name
        FROM t_company_bill cb, t_company c
        WHERE cb.is_valid = '1'
        AND c.is_valid = '1'
        AND cb.company_id = c.id
        <if test="company_id != null and !&quot;&quot;.equals(company_id)">
            AND cb.company_id = #{company_id}
        </if>
        <if test="garden_id != null and !&quot;&quot;.equals(garden_id)">
            AND c.garden_id = #{garden_id}
        </if>
        <if test="fee_type != null and !&quot;&quot;.equals(fee_type)">
            AND cb.fee_type = #{fee_type}
        </if>
        <if test="expiry_time_start != null and !&quot;&quot;.equals(expiry_time_start)">
            AND cb.expiry_time >= #{expiry_time_start}
        </if>
        <if test="expiry_time_end != null and !&quot;&quot;.equals(expiry_time_end)">
            AND cb.expiry_time <![CDATA[ <= ]]> #{expiry_time_end}
        </if>
        <if test="pay_time_start != null and !&quot;&quot;.equals(pay_time_start)">
            AND cb.pay_time >= #{pay_time_start}
        </if>
        <if test="pay_time_end != null and !&quot;&quot;.equals(pay_time_end)">
            AND cb.pay_time <![CDATA[ <= ]]> #{pay_time_end}
        </if>
        <if test="is_paid != null and !&quot;&quot;.equals(is_paid)">
            AND cb.is_paid = #{is_paid}
        </if>
        <if test="is_pushed != null and !&quot;&quot;.equals(is_pushed)">
            AND cb.is_pushed = #{is_pushed}
        </if>
        <if test="condition != null and !&quot;&quot;.equals(condition)">
            AND (
            c.company_name like concat('%', #{condition}, '%')
            OR cb.bill_num like concat('%', #{condition}, '%')
            )
        </if>

        ORDER BY cb.create_time DESC
    </select>

    <update id="push" parameterType="String"  >

        update t_company_bill
        set is_pushed = '1',
        push_time = now(),
        modify_time = now(),
        modify_id = 'system'
        where push_time <![CDATA[ <= ]]> now()
        and is_valid = '1'
        AND is_pushed = '0'
        <if test="company_id != null and !&quot;&quot;.equals(company_id)">
            AND company_id = #{company_id}
        </if>
    </update>

    <select id="selectpush" parameterType="String" resultType="Dto">
        select cb.*,
        (
        case
        when cb.fee_type='0' then "水费"
        when cb.fee_type='1' then "电费"
        when cb.fee_type='2' then "燃气费"
        when cb.fee_type='3' then "房租物业"
        end
        ) as bill_name,
        (
        case
        when cb.is_paid='0' then "未缴费"
        when cb.is_paid='1' then "已缴费"
        end
        ) as bill_is_paid,
        c.garden_id ,c.company_name ,u.phone_num ,wxa.app_id
        from t_company_bill cb,t_company_user_role cur ,t_role r,t_company c,
        tbl_wxopen_authorizer_account_info wxa ,t_property_weixin_public_config pwx,t_user u,t_garden g
        WHERE cb.push_time <![CDATA[ <= ]]> now()
        and cb.is_valid = '1'
        AND cur.is_valid = '1'
        AND  r.is_valid = '1'
        AND  u.is_valid = '1'
        AND  c.is_valid = '1'
        AND  g.is_valid = '1'
        AND pwx.is_valid = '1'
        AND  cb.company_id = cur.company_id
        AND cur.role_id = r.id
        AND r.id = #{company_admin_id}
        AND cur.user_id = u.id
        AND cb.is_pushed = '0'
        AND  c.id = cb.company_id
        AND c.garden_id = g.id
        AND g.property_id = pwx.property_id
        AND pwx.weixin_config_id = wxa.id
        <if test="company_id != null and !&quot;&quot;.equals(company_id)">
            AND cb.company_id = #{company_id}
        </if>
        limit 1
    </select>

    <select id="selectPushByBillId" parameterType="Dto" resultType="Dto">
        select cb.*,
        (
        case
        when cb.fee_type='0' then "水费"
        when cb.fee_type='1' then "电费"
        when cb.fee_type='2' then "燃气费"
        when cb.fee_type='3' then "房租物业"
        end
        ) as bill_name,
        (
        case
        when cb.is_paid='0' then "未缴费"
        when cb.is_paid='1' then "已缴费"
        end
        ) as bill_is_paid,
        c.garden_id ,c.company_name ,u.phone_num ,wxa.app_id
        from t_company_bill cb,t_company_user_role cur ,t_role r,t_company c,
        tbl_wxopen_authorizer_account_info wxa ,t_property_weixin_public_config pwx,t_user u,t_garden g
        WHERE
        cb.is_valid = '1'
        AND cur.is_valid = '1'
        AND  r.is_valid = '1'
        AND  u.is_valid = '1'
        AND  c.is_valid = '1'
        AND  g.is_valid = '1'
        AND pwx.is_valid = '1'
        AND  cb.company_id = cur.company_id
        AND cur.role_id = r.id
        AND r.id = #{company_admin_id}
        AND cur.user_id = u.id
        AND cb.is_paid = '0'
        AND  c.id = cb.company_id
        AND c.garden_id = g.id
        AND g.property_id = pwx.property_id
        AND pwx.weixin_config_id = wxa.id
        <if test="company_bill_id != null and !&quot;&quot;.equals(company_bill_id)">
            AND cb.id = #{company_bill_id}
        </if>
        limit 1
    </select>

    <select id="getBillDetail" parameterType="String" resultType="Dto">
        SELECT cb.*,
        (
        case
        when cb.fee_type='0' then "水费"
        when cb.fee_type='1' then "电费"
        when cb.fee_type='2' then "燃气费"
        when cb.fee_type='3' then "房租物业"
        end
        ) as billName,
        c.company_name
        FROM t_company_bill cb,t_company c WHERE
        cb.is_valid = '1'
        AND c.is_valid = '1'
        AND c.id = cb.company_id
        <if test="billId != null and !&quot;&quot;.equals(billId)">
            AND cb.id = #{billId}
        </if>
    </select>


    <select id="listpageByorder" parameterType="Dto" resultType="Dto">
        select *,
        concat(
        case
        when fee_type='0' then "水费"
        when fee_type='1' then "电费"
        when fee_type='2' then "燃气费"
        when fee_type='3' then "房租"
        when fee_type='4' then "物业费"
        end
        ) as billName
        from t_company_bill
        <where>
            bill_year_month in
            ( select * from
            ( select DISTINCT bill_year_month as month from t_company_bill  where
            company_id = #{companyId, jdbcType=VARCHAR}  <!-- 企业id -->
            GROUP BY bill_year_month DESC limit
            <if test="startpage != null">
                #{startpage, jdbcType=VARCHAR},  <!-- 开始条数 -->
            </if>


            <if test="pageSize != null">
                #{pageSize, jdbcType=VARCHAR} <!-- 分页月份size -->
            </if>
            ) as b)
            <if test="isPaid != null and isPaid != '' ">
               and is_paid = #{isPaid}
            </if>
            AND is_valid = '1'
            AND
            company_id = #{companyId, jdbcType=VARCHAR}  <!-- 企业id -->
        </where>
        ORDER  by bill_year_month DESC
    </select>


    <select id="billbymonth" parameterType="Dto" resultType="Dto">
        select *,
        concat(
        case
        when fee_type='0' then "水费"
        when fee_type='1' then "电费"
        when fee_type='2' then "燃气费"
        when fee_type='3' then "房租"
        when fee_type='4' then "物业费"
        end
        ) as billName
        from t_company_bill where
        bill_year_month = #{billYearMonth, jdbcType=VARCHAR}  <!-- 企业id -->
        AND
        company_id = #{companyId, jdbcType=VARCHAR}  <!-- 企业id -->

    </select>

    <select id="getNotPaidTotal" resultType="java.lang.String">
        select sum(total_fee) from t_company_bill where is_paid = 0 and is_valid = 1
        AND  company_id = #{company_id,jdbcType=VARCHAR}
    </select>
</mapper>